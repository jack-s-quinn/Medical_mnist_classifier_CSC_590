# src/app.py
import gradio as gr
import torch
from PIL import Image
from torchvision import transforms
import json
import timm
import io

MODEL_PATH = "model.pt"
LABELS_PATH = "labels.json"
IMAGE_SIZE = 224
MODEL_NAME = "tf_efficientnet_b0"

def load_model(model_path=MODEL_PATH, model_name=MODEL_NAME, device=None):
    if device is None:
        device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
    # load labels
    with open(LABELS_PATH, "r") as f:
        labels = json.load(f)
    num_classes = len(labels)
    model = timm.create_model(model_name, pretrained=False, num_classes=num_classes)
    state = torch.load(model_path, map_location=device)
    model.load_state_dict(state)
    model.to(device)
    model.eval()
    return model, labels, device

model, labels, device = load_model()

transform = transforms.Compose([
    transforms.Resize((IMAGE_SIZE, IMAGE_SIZE)),
    transforms.ToTensor(),
    transforms.Normalize([0.485,0.456,0.406],[0.229,0.224,0.225])
])

def predict(img: Image.Image):
    if img.mode != "RGB":
        img = img.convert("RGB")
    x = transform(img).unsqueeze(0).to(device)
    with torch.no_grad():
        logits = model(x)
        probs = torch.nn.functional.softmax(logits, dim=1).cpu().numpy()[0]
    # top5
    topk = 5
    idxs = probs.argsort()[::-1][:topk]
    results = [(labels[i], float(probs[i])) for i in idxs]
    # display primary label with prob
    primary = results[0]
    return {labels[i]: float(probs[i]) for i in range(len(labels))}, primary[0], float(primary[1])

title = "Medical-MNIST classifier"
description = "Upload an image and the model will predict which modality/location it belongs to: AbdomenCT, BreastMRI, CXR, ChestCT, Hand, HeadCT."

examples = []  # You can add example images if you include them in the Space repo.

demo = gr.Interface(
    fn=predict,
    inputs=gr.Image(type="pil"),
    outputs=[gr.Label(num_top_classes=6), gr.Textbox(label="Top prediction"), gr.Number(label="Top probability")],
    title=title,
    description=description,
    examples=examples,
    allow_flagging="never",
)

if __name__ == "__main__":
    demo.launch()
